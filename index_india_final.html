<!DOCTYPE html>
<html>
<head>
    <title>India State Quiz</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body { font-family: Arial; text-align: center; }
        /* overlays sit above the map */
        #map-overlays { position: relative; height: 64px; }
        #map { height: 600px; margin-top: 8px; background: #f4f4f4; }
        .overlay { position: absolute; z-index: 400; padding: 6px 10px; background: rgba(255,255,255,0.95); border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); font-weight: 600; }
        .top-left { left: 8px; top: 8px; }
        .top-right { right: 8px; top: 8px; }
        .center-top { left: 50%; top: 8px; transform: translateX(-50%); font-size: 20px; }
        #question { font-size: 18px; }
        #score { font-size: 16px; }
    </style>
</head>
<body>

<div id="map-overlays">
    <div class="overlay top-left">Quiz : India States</div>
    <div id="score" class="overlay top-right"><span id="score-text">Score: 0%</span> <span id="timer" style="margin-left:12px;font-weight:400;font-size:15px;"></span></div>
    <div id="question" class="overlay center-top">Loading...</div>
</div>
<div id="map"></div>

<script>

var map = L.map('map').setView([22, 80], 5);

// No basemap tiles â€” the quiz will show only the GeoJSON layer

let states = [];
let currentState = "";
let totalQuestions = 0;
let correctAnswers = 0;
let geoLayer;
// Configure how many questions the quiz should ask (set 0 for unlimited)
let maxQuestions = 30;
// Attempts allowed per question
let attemptsLeft = 3;
// Total click attempts used for scoring (correct + wrong clicks)
let attemptsCount = 0;
// When true, the quiz will not advance until the correct state is clicked
let requireCorrectToAdvance = false;
let correctLayerForCurrent = null;


fetch("india_states.geojson")
.then(response => response.json())
.then(data => {

    states = data.features.map(f => f.properties.ST_NM);

    geoLayer = L.geoJSON(data, {
        style: {
            color: "black",
            weight: 1,
            fillColor: "#cccccc",
            fillOpacity: 0.6
        },
        onEachFeature: function (feature, layer) {
            layer.on({
                mouseover: function (e) {
                    layer.setStyle({ weight: 2, color: '#666' });
                },
                mouseout: function (e) {
                    geoLayer.resetStyle(layer);
                },
                click: function (e) {

                    const stateName = feature && feature.properties && feature.properties.ST_NM;
                    const origFill = '#cccccc';

                        // increment attempts count (used for scoring)
                        attemptsCount++;

                        if (stateName === currentState) {

                            // Correct: show green for 2s
                            correctAnswers++;
                            updateScore();
                            layer.setStyle({ fillColor: 'green' });
                            setTimeout(() => {
                                geoLayer.resetStyle(layer);
                                nextQuestion();
                            }, 2000);

                        } else {
                            // Incorrect: decrement attempts
                            updateScore();
                            attemptsLeft = Math.max(0, attemptsLeft - 1);
                            if (attemptsLeft > 0) {
                                // red for 2s on the clicked (wrong) layer
                                layer.setStyle({ fillColor: 'red' });
                                setTimeout(() => geoLayer.resetStyle(layer), 2000);
                            } else {
                                // after 3 consecutive wrong tries: show correct state by flickering it for 3s
                                let correctLayer = null;
                                geoLayer.eachLayer(function (lyr) {
                                    const nm = lyr.feature && lyr.feature.properties && (lyr.feature.properties.ST_NM || lyr.feature.properties.shape1 || lyr.feature.properties.NAME);
                                    if (nm === currentState) correctLayer = lyr;
                                });
                                if (correctLayer) {
                                    let on = true;
                                    const orig = correctLayer.options.fillColor || '#cccccc';
                                    const iv = setInterval(() => {
                                        correctLayer.setStyle({ fillColor: on ? 'red' : orig });
                                        on = !on;
                                    }, 250);
                                    setTimeout(() => {
                                        clearInterval(iv);
                                        geoLayer.resetStyle(correctLayer);
                                        // Do NOT auto-advance; require the user to click the correct state to continue
                                        requireCorrectToAdvance = true;
                                        correctLayerForCurrent = correctLayer;
                                        // visually indicate the correct target (outline)
                                        try { correctLayer.setStyle({ weight: 3, color: '#2a7fff' }); } catch(e) {}
                                        // update the prompt to make the requirement clear
                                        const q = document.getElementById('question');
                                        if (q) q.innerHTML = "Click on: <b>" + currentState + "</b> (click the correct state to continue)";
                                    }, 3000);
                                } else {
                                    // fallback: if we can't locate the correct layer, advance
                                    nextQuestion();
                                }
                            }
                            // show a short tooltip with the clicked state's name at the click location
                            let tooltipContent = stateName || 'Unknown';
                            layer.bindTooltip(tooltipContent, {
                                permanent: false,
                                className: 'wrong-tooltip',
                                direction: 'top',
                                offset: [0, -10]
                            }).openTooltip(e && e.latlng ? e.latlng : undefined);
                            setTimeout(()=> layer.closeTooltip(), 1200);
                        }

                }
            });
        }
    }).addTo(map);

    // Fit to GeoJSON bounds for a better initial view
    try { map.fitBounds(geoLayer.getBounds()); } catch(e) { }

    startTimer();
    nextQuestion();
});

function nextQuestion() {

    // Clear any 'must click correct to advance' state from previous question
    requireCorrectToAdvance = false;
    if (correctLayerForCurrent) {
        try { geoLayer.resetStyle(correctLayerForCurrent); } catch(e) {}
        correctLayerForCurrent = null;
    }

    // If maxQuestions is set and we've already asked that many, finish
    if (maxQuestions > 0 && totalQuestions >= maxQuestions) {
        endQuiz();
        return;
    }

    if (!states || states.length === 0) {
        endQuiz();
        return;
    }

    // Pick a random state and remove it from the pool to avoid repeats
    const idx = Math.floor(Math.random() * states.length);
    currentState = states.splice(idx, 1)[0];

    // reset attempts for this question
    attemptsLeft = 3;

    totalQuestions++;

    document.getElementById("question").innerHTML =
        "Click on: <b>" + currentState + "</b>";
}

function updateScore() {
    // Score = correct clicks / total clicks (attempts)
    let percentage = attemptsCount === 0 ? 0 : Math.round((correctAnswers / attemptsCount) * 100);
    document.getElementById("score-text").innerHTML =
        "Score: " + percentage + "%";
}

// Timer logic
let timerInterval = null;
let startTime = null;
function startTimer() {
    startTime = Date.now();
    timerInterval = setInterval(updateTimer, 1000);
}
function updateTimer() {
    if (!startTime) return;
    const now = Date.now();
    const elapsed = Math.floor((now - startTime) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    document.getElementById("timer").textContent =
        "Time: " + mins + ":" + (secs < 10 ? "0" : "") + secs;
}
function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = null;
}

function endQuiz() {
    stopTimer();
    const percent = attemptsCount === 0 ? 0 : Math.round((correctAnswers / attemptsCount) * 100);
    document.getElementById("question").innerHTML =
        "Quiz finished! Final score: <b>" + percent + "%</b>";

    // Disable interactions on all layers
    if (geoLayer) {
        geoLayer.eachLayer(function (layer) {
            layer.off();
        });
    }

    // Optionally show restart control
    const restart = document.createElement('button');
    restart.textContent = 'Restart Quiz';
    restart.style.marginLeft = '10px';
    restart.onclick = function () { location.reload(); };
    const q = document.getElementById('question');
    if (q) q.appendChild(restart);
}

</script>

</body>
</html>